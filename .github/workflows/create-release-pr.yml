name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          if ! echo "${{ github.event.inputs.version }}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Update version in Cargo.toml
        run: |
          sed -i 's/^version = ".*"/version = "${{ github.event.inputs.version }}"/' Cargo.toml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/${{ github.event.inputs.version }}
          commit-message: "chore: bump version to ${{ github.event.inputs.version }}"
          committer: F9Uf <atoseka@gmail.com>
          author: F9Uf <atoseka@gmail.com>
          title: "Release v${{ github.event.inputs.version }}"
          body: |
            ## Release v${{ github.event.inputs.version }}
            
            This PR prepares the release for version ${{ github.event.inputs.version }}.
            
            ### Changes
            - Updated version in Cargo.toml to ${{ github.event.inputs.version }}
            
            ### Release Process
            Once this PR is merged, the release workflow will automatically:
            1. Create a git tag `v${{ github.event.inputs.version }}`
            2. Build the release binary for x86_64-apple-darwin
            3. Create a GitHub release with the artifacts
            
            ### Installation
            After the release is published, users can install with:
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/v${{ github.event.inputs.version }}/gbi-v${{ github.event.inputs.version }}-x86_64-apple-darwin.tar.gz | tar xz && sudo mv gbi-x86_64-apple-darwin /usr/local/bin/gbi
            ```
          labels: release
          base: main
